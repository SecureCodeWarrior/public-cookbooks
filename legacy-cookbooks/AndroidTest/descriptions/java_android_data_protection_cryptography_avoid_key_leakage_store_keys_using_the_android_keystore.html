<html>
<body>
<h2>Abstract</h2>
Secure coding practices prescribe to securely store encryption keys by using the Android <code>Keystore</code> provider.
<h2>Description</h2>
The Android system provides two APIs to securely store small secrets. The <code>KeyChain</code> API is used for system-wide credentials, here the user can choose through a user interface to which credentials the app can access.  <b>Use the Android <code>Keystore</code> provider to let an individual app store its own credentials</b> that only the app itself can access. This method requires no user interaction to select the credentials. To use this feature,  use the standard <code>KeyStore</code> and <code>KeyPairGenerator</code> or <code>KeyGenerator</code> classes.

<h3>Add a key to the keystore</h3>
Each key created by an app must have a unique alias, which can be any <code>String</code>. In the example below a <code>KeyPairGeneratorSpec</code> object is used to build the specifications of the required key. The validity period of the key, the alias and the subject (for self signed keys) among others can be set using this class. Generating a key using <code>KeyGenerator</code> or <code>KeyPairGenerator</code> this way will add it to the keystore.
<h4>Correct code example:</h4>
<pre>
KeyPairGeneratorSpec spec = new KeyPairGeneratorSpec.Builder(this)
    .<b>setAlias(alias)</b>
    .setSubject(new X500Principal("CN=Encryption Key, O=Secure Code Warrior"))
    .setSerialNumber(BigInteger.ONE)
    .setStartDate(start.getTime())
    .setEndDate(end.getTime())
    .build();
KeyPairGenerator generator = KeyPairGenerator.getInstance("RSA", "AndroidKeyStore");
generator.initialize(spec);
KeyPair keyPair = <b>generator.generateKeyPair()</b>;
</pre>

<h3>Get a keystore instance</h3>
Before any actions can be done with keys, a keystore instance is needed.
<h4>Correct code example:</h4>
<pre>
<b>Keystore.getInstance("AndroidKeyStore");</b>
keystore.load(null);
</pre>

<h3>Get a key from the keystore</h3>
After getting the keystore instance, one can easily get a <code>KeyEntry</code> by its alias. This <code>KeyEntry</code> has methods available to require the actual key.
<h4>Correct code example:</h4>
<pre>
KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)keyStore.<b>getEntry(alias, null)</b>;
RSAPrivateKey privateKey = (RSAPrivateKey) privateKeyEntry.getPrivateKey();
</pre>

<h3>Remove a key from the keystore</h3>
After getting the keystore instance, the method <code>deleteEntry</code> can be used to delete a key by its alias.
<pre>
<b>keyStore.deleteEntry(alias)</b>;
refreshKeys();
</pre>

<!-- Sources:
    https://www.androidauthority.com/use-android-keystore-store-passwords-sensitive-information-623779/
    https://developer.android.com/reference/javax/security/auth/x500/X500Principal.html
    https://developer.android.com/training/articles/keystore.html
    https://developer.android.com/reference/java/security/KeyStore.html
    https://source.android.com/security/keystore/ -->     
        <h2>Violating this guideline can cause</h2>
        
        <h4>Mobile vulnerabilities</h4>
            <ul>
            
                <li>Broken Cryptography - Insecure Storage Of Encryption Keys. <a href="https://{{microtraininghost}}/#/simple-flow/mobile/broken_cryptography/insecure_storage_of_encryption_keys/java/android?utm_source=sensei&utm_content=problemdescription">Learn more</a></li>
            </ul>
        
        
    
        <h2>Sensei quick fix</h2>
        <p>Use the <b>Sensei&reg; Quick Fix technology: Hit {{{ qfshortcut }}}</b> to fix this guideline violation automatically.</p>

</body>
</html>