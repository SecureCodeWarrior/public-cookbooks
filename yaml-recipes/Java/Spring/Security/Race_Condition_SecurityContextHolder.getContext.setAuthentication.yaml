id: scw:spring:race-condition-SecurityContext
version: 8
metadata:
  name: 'Spring Security: race condition: SecurityContextHolder.getContext.setAuthentication'
  shortDescription: It is important to create a new SecurityContext instance to avoid
    race conditions across multiple threads.
  level: error
  language: java
  scwCategory: ""
  enabled: true
  comment: https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-authentication-securitycontextholder
search:
  methodcall:
    name: setAuthentication
    declaration:
      type: org.springframework.security.core.context.SecurityContext
    "on":
      methodcall:
        name: getContext
        declaration:
          type: org.springframework.security.core.context.SecurityContextHolder
availableFixes:
- name: assign a new SecurityContext to the holder
  actions:
  - rewrite:
      to: |-
        org.springframework.security.core.context.SecurityContext newContext = org.springframework.security.core.context.SecurityContextHolder.createEmptyContext();
        newContext.setAuthentication({{{ arguments.0 }}});
        SecurityContextHolder.setContext(newContext)
